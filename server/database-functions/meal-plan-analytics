CREATE OR REPLACE FUNCTION calculate_meal_plan_analytics()
RETURNS VOID AS
$$
BEGIN
    INSERT INTO meal_plan_analytics (provider_id, plan_id, plan_name, customers_count_per_plan, total_customers, created_at)
    WITH meal_plans_data AS (
        SELECT 
            p.id AS provider_id,
            pl.plan_id,
            pl.plan_name,
            COUNT(c.customer_id) AS customers_count_per_plan
        FROM 
            providers p
        LEFT JOIN 
            plans pl ON p.id = pl.provider_id
        LEFT JOIN 
            customers c ON pl.plan_id = c.plan_id
        GROUP BY 
            p.id, pl.plan_id, pl.plan_name
    ),
    total_customers_data AS (
        SELECT 
            p.id AS provider_id,
            COUNT(c.customer_id) AS total_customers
        FROM 
            providers p
        LEFT JOIN 
            customers c ON p.id = c.provider_id
        GROUP BY 
            p.id
    )
    SELECT 
        mpd.provider_id,
        p.business_name AS provider_name,
        mpd.plan_id,
        mpd.plan_name,
        COALESCE(mpd.customers_count_per_plan, 0) AS customers_count_per_plan,
        COALESCE(tcd.total_customers, 0) AS total_customers,
        CURRENT_DATE AS date_calculated
    FROM 
        meal_plans_data mpd
    LEFT JOIN 
        providers p ON mpd.provider_id = p.id
    LEFT JOIN 
        total_customers_data tcd ON mpd.provider_id = tcd.provider_id;

END;
$$
LANGUAGE plpgsql;